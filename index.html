<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 26px;
  max-width: 700px;
  margin: 0 auto;
}

.hidden { display: none; }

h1 { font-size: 34px; }

button, input {
  padding: 16px;
  font-size: 26px;
  width: 100%;
  max-width: 420px;
  margin: 8px auto;
  border-radius: 14px;
}

#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 20px auto;
  overflow: hidden;
}

#video video, #video canvas {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover;
}

.variant, .cart-item {
  border: 2px solid #333;
  border-radius: 12px;
  padding: 14px;
  margin: 10px 0;
  background: #fff;
}

#result {
  margin-top: 16px;
  padding: 16px;
  border-radius: 12px;
  background: #f4f4f4;
  font-weight: bold;
}
</style>
</head>

<body>

<!-- HOME -->
<div id="home">
  <h1>üì¶ Inventory System</h1>
  <button onclick="openPriceCheck()">üí≤ Price Check</button>
  <button onclick="openSignOut()">üìù Sample Sign Out</button>
</div>

<!-- PRICE CHECK -->
<div id="priceCheck" class="hidden">
  <button onclick="goHome()">‚¨Ö Home</button>
  <h1>üí≤ Price Check</h1>
  <div id="video"></div>

  <input id="barcodeInput" placeholder="Enter barcode or item name"
    onkeydown="if(event.key==='Enter') lookupManual()" />

  <button onclick="lookupManual()">Search</button>
  <div id="result">Waiting for scan...</div>
</div>

<!-- SAMPLE SIGN OUT -->
<div id="signOut" class="hidden">
  <button onclick="goHome()">‚¨Ö Home</button>
  <h1>üìù Sample Sign Out</h1>

  <div id="video"></div>

  <input id="signoutSearch" placeholder="Scan or search product" />

  <button onclick="startNewList()">‚ûï Start New List</button>
  <button onclick="cancelList()">‚ùå Cancel</button>

  <div id="signoutResult"></div>

  <h3>Selected Samples</h3>
  <div id="cart"></div>

  <input id="custName" placeholder="Customer Name" />
  <input id="custPhone" placeholder="Customer Phone" />

  <button onclick="submitSignOut()">‚úÖ Sign Out</button>
</div>

<script>
/* ---------- SHARED ---------- */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t="
  + Date.now();

let inventoryData = {};
let scanLocked = false;
let currentMode = "price";

/* ---------- LOAD INVENTORY ---------- */
async function loadInventory() {
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );
  const headers = rows[0];

  rows.slice(1).forEach(row => {
    const entry = {};
    headers.forEach((h, i) => {
      entry[h.trim()] = row[i]?.replace(/"/g,"").trim() || "";
    });
    if (!inventoryData[row[0]]) inventoryData[row[0]] = [];
    inventoryData[row[0]].push(entry);
  });
}

/* ---------- NAV ---------- */
function goHome() {
  stopScanner();
  document.querySelectorAll("div").forEach(d => d.classList.add("hidden"));
  document.getElementById("home").classList.remove("hidden");
}

function openPriceCheck() {
  currentMode = "price";
  startScanner();
  document.getElementById("home").classList.add("hidden");
  document.getElementById("priceCheck").classList.remove("hidden");
}

function openSignOut() {
  currentMode = "signout";
  startScanner();
  document.getElementById("home").classList.add("hidden");
  document.getElementById("signOut").classList.remove("hidden");
}

/* ---------- PRICE CHECK ---------- */
function lookupManual() {
  handleBarcode(barcodeInput.value.trim());
}

function showVariant(item) {
  scanLocked = true;
  result.innerHTML = `
    <div>${item["Item Name"]}</div>
    <div style="font-size:36px">${item["Price"]}</div>
    <button onclick="unlock()">üì∑ Scan Next</button>
  `;
}

/* ---------- SIGN OUT ---------- */
let cart = [];

function startNewList() {
  cart = [];
  updateCart();
  unlock();
}

function cancelList() {
  cart = [];
  updateCart();
  signoutResult.innerHTML = "";
  unlock();
}

function addToCart(item) {
  cart.push(item["Item Name"]);
  updateCart();
  unlock();
}

function updateCart() {
  cartDiv = document.getElementById("cart");
  cartDiv.innerHTML = "";
  cart.forEach(p => {
    cartDiv.innerHTML += `<div class="cart-item">${p}</div>`;
  });
}

function submitSignOut() {
  alert("Ready for Apps Script hookup next üëç");
}

/* ---------- SCANNER ---------- */
function unlock() {
  scanLocked = false;
}

function handleBarcode(code) {
  if (scanLocked) return;
  const items = inventoryData[code];
  if (!items) return;

  scanLocked = true;

  let html = `<div>Select product:</div>`;
  items.forEach(i => {
    html += `
      <div class="variant">
        <div>${i["Item Name"]}</div>
        <button onclick='${currentMode==="price" ? "showVariant" : "addToCart"}(${JSON.stringify(i)})'>
          Select
        </button>
      </div>`;
  });

  if (currentMode === "price") result.innerHTML = html;
  else signoutResult.innerHTML = html;
}

function startScanner() {
  loadInventory().then(() => {
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: { facingMode: "environment" }
      },
      decoder: { readers: ["code_128_reader"] }
    }, err => {
      if (!err) Quagga.start();
    });

    Quagga.onDetected(d => handleBarcode(d.codeResult.code));
  });
}

function stopScanner() {
  try { Quagga.stop(); } catch {}
}
</script>

</body>
</html>
