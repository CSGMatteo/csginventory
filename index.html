<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner App</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 26px;
  max-width: 700px;
  margin: 0 auto;
}
h1 { font-size: 34px; margin-bottom: 16px; }
button {
  padding: 18px;
  font-size: 26px;
  width: 100%;
  max-width: 420px;
  border-radius: 14px;
  margin-top: 12px;
}
#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 20px auto;
  overflow: hidden;
}
#video video, #video canvas {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover;
}
.hidden { display:none; }
.variant {
  border: 2px solid #333;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
}
#result, #signout-result {
  margin-top: 20px;
  padding: 20px;
  border: 3px solid #333;
  border-radius: 14px;
  background: #f4f4f4;
}
input {
  padding: 16px;
  font-size: 24px;
  width: 100%;
  max-width: 420px;
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>üì¶ Inventory Scanner</h1>

<!-- LANDING -->
<div id="landing">
  <button onclick="openPrice()">üîç Price Check</button>
  <button onclick="openSignOut()">üìã Sample Sign Out</button>
</div>

<!-- PRICE CHECK -->
<div id="pricePage" class="hidden">
  <button onclick="goHome()">üè† Home</button>
  <div id="video"></div>
  <input id="searchInput" placeholder="Enter barcode or name"
         onkeydown="if(event.key==='Enter') manualSearch()">
  <button onclick="manualSearch()">Search</button>
  <div id="result">Waiting for scan...</div>
</div>

<!-- SIGN OUT -->
<div id="signoutPage" class="hidden">
  <button onclick="goHome()">üè† Home</button>
  <div id="video-signout"></div>

  <input id="searchInputSign" placeholder="Enter barcode or name"
         onkeydown="if(event.key==='Enter') manualSearchSignout()">
  <button onclick="manualSearchSignout()">Search</button>

  <div id="signout-result">Scan items to add</div>

  <input id="custName" placeholder="Customer Name">
  <input id="custPhone" placeholder="Customer Phone">

  <button onclick="startNewList()">‚ñ∂ Start New List</button>
  <button onclick="submitSignOut()">‚úÖ Sign Out Samples</button>
  <button onclick="cancelSignOut()">‚ùå Cancel</button>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/export?format=csv&t="+Date.now();
const SCRIPT_URL = "YOUR_APPS_SCRIPT_WEBAPP_URL";

let inventory = {};
let scanLocked = false;
let cart = [];
let activePage = "";

function formatDate() {
  const d = new Date();
  return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
}

function show(id){
  ["landing","pricePage","signoutPage"].forEach(p=>document.getElementById(p).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function goHome(){
  Quagga.stop();
  show("landing");
}

function openPrice(){
  activePage="price";
  show("pricePage");
  startScanner("#video");
}

function openSignOut(){
  activePage="signout";
  show("signoutPage");
  startScanner("#video-signout");
}

async function loadInventory(){
  if(Object.keys(inventory).length) return;
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = text.split("\n").map(r=>r.split(","));
  const headers = rows[0];
  rows.slice(1).forEach(r=>{
    if(!r[0]) return;
    const item = {};
    headers.forEach((h,i)=>item[h.trim()]=r[i]?.replace(/"/g,"").trim());
    if(!inventory[r[0]]) inventory[r[0]]=[];
    inventory[r[0]].push(item);
  });
}

function startScanner(target){
  loadInventory().then(()=>{
    Quagga.init({
      inputStream:{ type:"LiveStream", target:document.querySelector(target),
        constraints:{ facingMode:"environment" }},
      decoder:{ readers:["code_128_reader"] }
    },()=>Quagga.start());

    Quagga.onDetected(d=>{
      if(scanLocked) return;
      handleCode(d.codeResult.code);
    });
  });
}

function handleCode(code){
  const items = inventory[code];
  if(!items) return;
  scanLocked=true;

  let html="Select item:";
  items.forEach(i=>{
    html+=`
      <div class="variant">
        ${i["Item Name"]}<br>${i["Price"]}
        <button onclick='selectItem(${JSON.stringify(i)})'>Select</button>
      </div>`;
  });
  document.getElementById(activePage==="price"?"result":"signout-result").innerHTML=html;
}

function selectItem(item){
  if(activePage==="price"){
    document.getElementById("result").innerHTML=
      `<b>${item["Item Name"]}</b><br>${item["Price"]}
       <button onclick="scanLocked=false">üì∑ Scan Next</button>`;
  } else {
    cart.push(item);
    document.getElementById("signout-result").innerHTML=
      cart.map(c=>`‚Ä¢ ${c["Item Name"]}`).join("<br>");
    scanLocked=false;
  }
}

function manualSearch(){ handleCode(searchInput.value); }
function manualSearchSignout(){ handleCode(searchInputSign.value); }

function startNewList(){ cart=[]; document.getElementById("signout-result").innerText="New list started"; }

function cancelSignOut(){ cart=[]; goHome(); }

function submitSignOut(){
  if(!cart.length) return alert("No items");
  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      items:cart.map(i=>i["Item Name"]),
      name:custName.value,
      phone:custPhone.value,
      date:formatDate()
    })
  }).then(()=>{ alert("Signed out"); goHome(); });
}
</script>
</body>
</html>
