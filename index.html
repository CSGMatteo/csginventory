<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner App</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 26px;
  max-width: 700px;
  margin: 0 auto;
}

h1 { font-size: 34px; margin-bottom: 16px; }

button {
  padding: 18px 22px;
  font-size: 26px;
  width: 100%;
  max-width: 420px;
  cursor: pointer;
  border-radius: 14px;
  margin-top: 12px;
}

input {
  padding: 14px;
  font-size: 22px;
  width: 100%;
  max-width: 420px;
  margin-top: 10px;
}

#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 20px auto;
  position: relative;
  overflow: hidden;
}

#video video, #video canvas {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover;
}

#result {
  margin-top: 22px;
  padding: 18px;
  border: 3px solid #333;
  border-radius: 16px;
  background: #f4f4f4;
}

.variant {
  border: 2px solid #333;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
}

.hidden { display: none; }
</style>
</head>

<body>

<h1>üì¶ Inventory Scanner</h1>

<!-- LANDING -->
<div id="landing">
  <button onclick="enterPriceMode()">üí≤ Price Check</button>
  <button onclick="enterSignOutMode()">üìã Sample Sign Out</button>
</div>

<!-- SCANNER -->
<div id="scanner-ui" class="hidden">
  <button onclick="goHome()">üè† Home</button>
  <div id="video"></div>

  <input id="barcodeInput" placeholder="Scan or search"
    onkeydown="if(event.key==='Enter') lookupManual()">
  <button onclick="lookupManual()">Search</button>

  <div id="result">Waiting for scan‚Ä¶</div>

  <!-- SIGN OUT CONTROLS -->
  <div id="signout-ui" class="hidden">
    <h3>üõí Selected Samples</h3>
    <div id="cart"></div>

    <input id="custName" placeholder="Customer Name">
    <input id="custPhone" placeholder="Customer Phone">

    <button onclick="submitSignOut()">‚úÖ Sign Out</button>
    <button onclick="resetSignOut()">üóë New List</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const APPS_SCRIPT_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

/* ================= STATE ================= */
let currentMode = "price";
let scanLocked = false;
let inventoryData = {};
let cart = [];

const resultDiv = document.getElementById("result");

/* ================= NAV ================= */
function goHome() {
  location.reload();
}

function enterPriceMode() {
  currentMode = "price";
  landing.classList.add("hidden");
  scannerUi.classList.remove("hidden");
  signoutUi.classList.add("hidden");
}

function enterSignOutMode() {
  currentMode = "signout";
  landing.classList.add("hidden");
  scannerUi.classList.remove("hidden");
  signoutUi.classList.remove("hidden");
  resultDiv.innerText = "Scan samples to add";
}

/* ================= INVENTORY ================= */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" +
  new Date().getTime();

async function loadInventory() {
  const text = await (await fetch(SHEET_URL)).text();
  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );

  const headers = rows[0];
  rows.slice(1).forEach(r => {
    if (!r[0]) return;
    const item = {};
    headers.forEach((h,i)=>item[h]=r[i]?.replace(/"/g,"").trim()||"");
    inventoryData[r[0]] ??= [];
    inventoryData[r[0]].push(item);
  });
}

/* ================= DISPLAY ================= */
function showVariants(barcode, items) {
  scanLocked = true;
  resultDiv.innerHTML = `<div>Select item:</div>`;
  items.forEach(i => {
    resultDiv.innerHTML += `
      <div class="variant">
        <div>${i["Item Name"]}</div>
        <div>${i["Price"]}</div>
        <button onclick='selectItem("${barcode}", ${JSON.stringify(i)})'>Select</button>
      </div>`;
  });
  resultDiv.innerHTML += `<button onclick="unlock()">Cancel</button>`;
}

function selectItem(barcode, item) {
  if (currentMode === "signout") {
    cart.push({ barcode, name: item["Item Name"] });
    renderCart();
  } else {
    resultDiv.innerHTML = `<div>${item["Item Name"]}</div><div>${item["Price"]}</div>`;
  }
  unlock();
}

function renderCart() {
  cartDiv.innerHTML = "";
  cart.forEach((c,i)=>{
    cartDiv.innerHTML += `<div>${i+1}. ${c.name}</div>`;
  });
}

function unlock() {
  scanLocked = false;
  resultDiv.innerText = currentMode === "price" ? "Waiting for scan‚Ä¶" : "Scan next sample‚Ä¶";
}

/* ================= LOOKUP ================= */
function handleBarcode(code) {
  if (!inventoryData[code]) {
    resultDiv.innerHTML = `<div>No match</div><button onclick="unlock()">Try Again</button>`;
    return;
  }
  showVariants(code, inventoryData[code]);
}

function lookupManual() {
  const v = barcodeInput.value.trim();
  if (inventoryData[v]) handleBarcode(v);
}

/* ================= SIGN OUT ================= */
function submitSignOut() {
  if (!cart.length) return alert("No samples added");

  const payload = {
    customer: custName.value,
    phone: custPhone.value,
    date: new Date().toLocaleDateString(),
    items: cart
  };

  fetch(APPS_SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(() => {
    alert("Samples signed out!");
    resetSignOut();
  });
}

function resetSignOut() {
  cart = [];
  renderCart();
}

/* ================= SCANNER ================= */
function startScanner() {
  loadInventory().then(()=>{
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: { facingMode: "environment" }
      },
      decoder: { readers: ["code_128_reader"] }
    }, err => {
      if (!err) Quagga.start();
    });

    Quagga.onDetected(d => {
      if (!scanLocked) handleBarcode(d.codeResult.code);
    });
  });
}

document.addEventListener("DOMContentLoaded", startScanner);
</script>

</body>
</html>
