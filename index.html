<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Barcode Scanner</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
  body { 
    font-family: Arial, sans-serif; 
    text-align: center; 
    padding: 16px; 
    font-size: 26px;
    max-width: 700px;
    margin: 0 auto;
  }
  h1 {
    font-size: 34px;
    margin-bottom: 16px;
  }
  #video {
    width: 100%;
    max-width: 650px;
    height: 260px;
    border: 4px solid #222;
    border-radius: 16px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
  }
  /* Red Line
  #video::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 5%;
    right: 5%;
    height: 3px;
    background: rgba(255, 0, 0, 0.7);
    transform: translateY(-50%);
  }
  */
  #video video, #video canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
    display: block;
  }
  input {
    padding: 18px;
    font-size: 26px;
    width: 100%;
    max-width: 420px;
    margin-bottom: 12px;
  }
  button {
    padding: 18px 22px;
    font-size: 26px;
    width: 100%;
    max-width: 420px;
    cursor: pointer;
    border-radius: 14px;
    margin-top: 8px;
  }
  #result {
    margin-top: 28px;
    font-size: 30px;
    padding: 22px;
    border: 3px solid #333;
    border-radius: 16px;
    background: #f4f4f4;
    line-height: 1.4;
    font-weight: bold;
  }
  .variant {
    border: 2px solid #333;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
    background: #fff;
  }
  #cart {
    margin-top: 20px;
    text-align: left;
  }
</style>
</head>

<body>

<h1>üì¶ Inventory Barcode Scanner</h1>

<div id="video"></div>

<!-- Customer Info -->
<input type="text" id="customerName" placeholder="Customer Name">
<input type="text" id="customerNumber" placeholder="Customer Number">

<input
  type="text"
  id="barcodeInput"
  placeholder="Enter barcode or item name"
  onkeydown="if(event.key==='Enter') lookupManual()"
/>

<button onclick="lookupManual()">Search</button>

<div id="result">Waiting for scan...</div>

<div id="cart"></div>

<script>
const resultDiv = document.getElementById("result");
const barcodeInput = document.getElementById("barcodeInput");

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwDc12CMYOYCPBwtIt0gT0Ph-2jvGmdM8xt22P8i53QkCdQu6Qm8vWAY8Cu0YINDimp/exec"; // <-- Replace with your Apps Script /exec URL

let scanLocked = false;
let pendingItem = null;
let pendingBarcode = null;
let cart = [];

let inventoryData = {};

/* ===============================
   SIZE QUOTE FIX (DISPLAY ONLY)
================================ */
function formatSizeQuotes(text) {
  if (!text) return "";
  text = text.replace(/\b(\d+(?:-\d+)?\/\d+)\b/g, '$1"');
  text = text.replace(/x\s*(\d+)(?!-\d+\/\d+)/g, 'x $1"');
  return text;
}

// Load inventory CSV from Google Sheet
async function loadInventory() {
  const SHEET_URL =
    "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" + new Date().getTime();

  const response = await fetch(SHEET_URL);
  const text = await response.text();

  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );
  const headers = rows[0];

  rows.slice(1).forEach(row => {
    if (!row[0]) return;
    const entry = {};
    headers.forEach((h, i) => {
      entry[h.trim()] = row[i]?.replace(/"/g, "").trim() || "";
    });
    const barcode = row[0].trim();
    if (!inventoryData[barcode]) inventoryData[barcode] = [];
    inventoryData[barcode].push(entry);
  });
}

/* ===============================
   CART LOGIC
================================ */
function renderCart() {
  const cartDiv = document.getElementById("cart");
  if (cart.length === 0) {
    cartDiv.innerHTML = "";
    return;
  }

  let html = `<h3>üõí Items (${cart.length})</h3>`;
  cart.forEach((item, i) => {
    html += `
      <div class="variant">
        ${formatSizeQuotes(item.name)}<br>
        <small>${item.barcode}</small><br>
        <button onclick="removeFromCart(${i})">Remove</button>
      </div>`;
  });
  html += `<button onclick="submitCart()">‚úÖ Submit All</button>`;
  cartDiv.innerHTML = html;
}

function removeFromCart(index) {
  cart.splice(index, 1);
  renderCart();
}

function submitCart() {
  const name = document.getElementById("customerName").value.trim();
  const number = document.getElementById("customerNumber").value.trim();

  if (!name || !number) {
    alert("Enter customer name and number first.");
    return;
  }

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      customerName: name,
      customerNumber: number,
      items: cart
    })
  });

  cart = [];
  renderCart();
  resultDiv.innerHTML = "‚úÖ Samples signed out!";
  unlockScanner();
}

/* ===============================
   SCAN CONFIRMATION LOGIC
================================ */
function showConfirm(item) {
  resultDiv.innerHTML = `
    <div style="font-size:28px;">${formatSizeQuotes(item["Item Name"])}</div>
    <div style="margin:10px 0;">Barcode: ${pendingBarcode}</div>
    <button onclick="addToCart()">‚ûï Add to Cart</button>
    <button onclick="unlockScanner()">‚ùå Cancel</button>
  `;
}

function addToCart() {
  cart.push({
    barcode: pendingBarcode,
    name: pendingItem["Item Name"],
    price: pendingItem["Price"]
  });
  unlockScanner();
  renderCart();
}

function showVariantConfirm(items) {
  let html = `<div>Select item:</div>`;
  items.forEach(item => {
    html += `
      <div class="variant">
        <div>${formatSizeQuotes(item["Item Name"])}</div>
        <button onclick='selectVariant(${JSON.stringify(item)})'>Select</button>
      </div>`;
  });
  html += `<button onclick="unlockScanner()">Cancel</button>`;
  resultDiv.innerHTML = html;
}

function selectVariant(item) {
  pendingItem = item;
  showConfirm(item);
}

/* ===============================
   MANUAL SEARCH
================================ */
function lookupManual() {
  const input = barcodeInput.value.trim().toLowerCase();
  if (!input) return;

  const matches = [];
  for (const barcode in inventoryData) {
    inventoryData[barcode].forEach(item => {
      if (item["Item Name"].toLowerCase().includes(input) || barcode === input) {
        matches.push({ barcode, item });
      }
    });
  }

  if (matches.length === 0) {
    resultDiv.innerHTML = `<div>No matches found</div><br><button onclick="unlockScanner()">Scan Again</button>`;
    return;
  }

  if (matches.length === 1) {
    pendingBarcode = matches[0].barcode;
    pendingItem = matches[0].item;
    showConfirm(pendingItem);
    return;
  }

  // Multiple matches
  let html = `<div>Multiple matches:</div>`;
  matches.forEach(m => {
    html += `
      <div class="variant">
        <div>${formatSizeQuotes(m.item["Item Name"])}</div>
        <button onclick='selectVariant(${JSON.stringify(m.item)})'>Select</button>
      </div>`;
  });
  html += `<button onclick="unlockScanner()">Cancel</button>`;
  resultDiv.innerHTML = html;
}

/* ===============================
   SCANNER LOGIC
================================ */
function unlockScanner() {
  scanLocked = false;
  pendingItem = null;
  pendingBarcode = null;
  resultDiv.innerText = "Waiting for scan...";
}

function handleBarcode(barcode) {
  const items = inventoryData[barcode];
  if (!items) {
    resultDiv.innerHTML = `<div>No match found</div><br><button onclick="unlockScanner()">Scan Again</button>`;
    return;
  }
  if (items.length === 1) {
    pendingItem = items[0];
    showConfirm(pendingItem);
  } else {
    showVariantConfirm(items);
  }
}

function startScanner() {
  loadInventory().then(() => {
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: { facingMode: "environment", width:{ideal:1920}, height:{ideal:1080} },
        area: { top:"40%", bottom:"40%", left:"10%", right:"10%" }
      },
      decoder: { readers: ["code_128_reader"] },
      locate: true
    }, err => {
      if(err){ resultDiv.innerText="Camera error. Check permissions."; return; }
      Quagga.start();
    });

    Quagga.onDetected(data => {
      if(scanLocked) return;
      pendingBarcode = data.codeResult.code;
      const items = inventoryData[pendingBarcode];
      if(!items){ resultDiv.innerHTML=`<div>No match found</div><br><button onclick="unlockScanner()">Scan Again</button>`; return; }
      if(items.length === 1){ pendingItem = items[0]; showConfirm(pendingItem); scanLocked=true; }
      else{ showVariantConfirm(items); scanLocked=true; }
    });
  });
}

document.addEventListener("DOMContentLoaded", startScanner);
</script>

</body>
</html>
