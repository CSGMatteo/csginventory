<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Barcode Scanner</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
  body { 
    font-family: Arial, sans-serif; 
    text-align: center; 
    padding: 16px; 
    font-size: 26px;
    max-width: 700px;
    margin: 0 auto;
  }

  h1 { font-size: 34px; margin-bottom: 12px; }

  #video {
    width: 100%;
    max-width: 650px;
    height: 260px;
    border: 4px solid #222;
    border-radius: 16px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
  }

  #video video, #video canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
  }

  input, button {
    padding: 18px;
    font-size: 26px;
    width: 100%;
    max-width: 420px;
    margin: 8px auto;
    border-radius: 14px;
  }

  .variant {
    border: 2px solid #333;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
    background: #fff;
  }

  #result {
    margin-top: 24px;
    padding: 20px;
    border: 3px solid #333;
    border-radius: 16px;
    background: #f4f4f4;
    font-weight: bold;
  }
</style>
</head>

<body>

<h1>üì¶ Inventory Barcode Scanner</h1>

<!-- ‚úÖ ADDED -->
<button onclick="enterSignOutMode()">üìù Sign Out Samples</button>

<div id="video"></div>

<input
  type="text"
  id="barcodeInput"
  placeholder="Enter barcode or item name"
  onkeydown="if(event.key==='Enter') lookupManual()"
/>

<button onclick="lookupManual()">Search</button>

<div id="result">Waiting for scan...</div>

<script>
/* ===============================
   CONFIG
================================ */
const WEB_APP_URL = "https://script.google.com/u/0/home/projects/1FlZkWEFjol2w5_VnvVOr5-xF6dfuVVY4U11IVqA0JqmLuXbtNZln7cLy/edit";

/* ===============================
   STATE
================================ */
let scanLocked = false;
let signOutMode = false;
let signOutList = [];
let inventoryData = {};

const resultDiv = document.getElementById("result");
const barcodeInput = document.getElementById("barcodeInput");

/* ===============================
   LOAD INVENTORY
================================ */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" +
  new Date().getTime();

async function loadInventory() {
  const response = await fetch(SHEET_URL);
  const text = await response.text();
  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );

  const headers = rows[0];
  rows.slice(1).forEach(row => {
    if (!row[0]) return;
    const entry = {};
    headers.forEach((h, i) => {
      entry[h.trim()] = row[i]?.replace(/"/g, "").trim() || "";
    });
    const barcode = row[0].trim();
    if (!inventoryData[barcode]) inventoryData[barcode] = [];
    inventoryData[barcode].push(entry);
  });
}

/* ===============================
   SIGN-OUT MODE UI
================================ */
function enterSignOutMode() {
  signOutMode = true;
  signOutList = [];
  resultDiv.innerHTML = `
    <strong>Sign-Out List</strong>
    <div id="cart"></div>
    <button onclick="unlockScanner()">‚ûï Add Sample</button>
    <hr>
    <input id="custName" placeholder="Customer Name">
    <input id="custPhone" placeholder="Customer Phone">
    <button onclick="submitSignOut()">‚úÖ Submit</button>
    <button onclick="exitSignOut()">‚ùå Cancel</button>
  `;
}

function exitSignOut() {
  signOutMode = false;
  signOutList = [];
  unlockScanner();
}

function updateCart() {
  const cart = document.getElementById("cart");
  cart.innerHTML = signOutList.map((b, i) => `
    <div>
      ${b}
      <button onclick="removeItem(${i})">‚ùå</button>
    </div>
  `).join("");
}

function removeItem(i) {
  signOutList.splice(i, 1);
  updateCart();
}

/* ===============================
   BARCODE HANDLING
================================ */
function showVariant(barcode, item) {
  if (signOutMode) {
    signOutList.push(barcode);
    updateCart();
    unlockScanner();
    return;
  }

  scanLocked = true;
  resultDiv.innerHTML = `
    <div>${item["Item Name"]}</div>
    <div style="font-size:38px">${item["Price"]}</div>
    <button onclick="unlockScanner()">üì∑ Scan Next</button>
  `;
}

function handleBarcode(barcode) {
  const items = inventoryData[barcode];
  if (!items) {
    resultDiv.innerHTML = `<div>No match</div><button onclick="unlockScanner()">Try Again</button>`;
    return;
  }
  items.length === 1
    ? showVariant(barcode, items[0])
    : showVariants(barcode, items);
}

function showVariants(barcode, items) {
  scanLocked = true;
  resultDiv.innerHTML = items.map(item => `
    <div class="variant">
      ${item["Item Name"]}<br>
      ${item["Price"]}
      <button onclick='showVariant("${barcode}", ${JSON.stringify(item)})'>Select</button>
    </div>
  `).join("");
}

/* ===============================
   MANUAL SEARCH
================================ */
function lookupManual() {
  const input = barcodeInput.value.trim().toLowerCase();
  if (inventoryData[input]) handleBarcode(input);
}

/* ===============================
   SUBMIT TO GOOGLE SHEETS
================================ */
async function submitSignOut() {
  const name = document.getElementById("custName").value.trim();
  const phone = document.getElementById("custPhone").value.trim();

  if (!name || !phone || !signOutList.length) {
    alert("Missing info or no samples added");
    return;
  }

  const res = await fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify({
      customerName: name,
      customerPhone: phone,
      barcodes: signOutList
    })
  });

  const json = await res.json();

  if (json.success) {
    alert(`Signed out ${json.updated} samples`);
    exitSignOut();
  } else {
    alert("Error: " + json.error);
  }
}

/* ===============================
   SCANNER
================================ */
function unlockScanner() {
  scanLocked = false;
  barcodeInput.value = "";
  if (!signOutMode) resultDiv.innerText = "Waiting for scan...";
}

function startScanner() {
  loadInventory().then(() => {
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: { facingMode: "environment" }
      },
      decoder: { readers: ["code_128_reader"] }
    }, err => {
      if (!err) Quagga.start();
    });

    Quagga.onDetected(d => {
      if (!scanLocked) handleBarcode(d.codeResult.code);
    });
  });
}

document.addEventListener("DOMContentLoaded", startScanner);
</script>

</body>
</html>
