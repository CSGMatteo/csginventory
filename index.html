<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner App</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 26px;
  max-width: 700px;
  margin: 0 auto;
}

h1 { font-size: 34px; margin-bottom: 16px; }

button {
  padding: 18px 22px;
  font-size: 26px;
  width: 100%;
  max-width: 420px;
  cursor: pointer;
  border-radius: 14px;
  margin-top: 12px;
}

input {
  font-size: 24px;
  padding: 12px;
  width: 100%;
  max-width: 420px;
  margin-top: 10px;
}

#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 20px auto;
  overflow: hidden;
}

#result, #cart {
  margin-top: 20px;
}

.variant {
  border: 2px solid #333;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 12px;
  background: #fff;
}

.hidden { display: none; }
</style>
</head>

<body>

<h1>üì¶ Inventory Scanner App</h1>

<!-- Landing -->
<div id="landing">
  <button onclick="enterPriceMode()">üí≤ Price Check</button>
  <button onclick="enterSignOutMode()">üìã Sample Sign Out</button>
</div>

<!-- Scanner UI -->
<div id="scanner-ui" class="hidden">
  <button onclick="goHome()">üè† Home</button>

  <div id="video"></div>

  <div id="result">Waiting for scan...</div>

  <!-- SIGN OUT CONTROLS -->
  <div id="signout-ui" class="hidden">
    <div id="cart"></div>

    <input id="customerName" placeholder="Customer Name">
    <input id="customerPhone" placeholder="Customer Phone">

    <button onclick="submitSignOut()">‚úÖ Sign Out Samples</button>
  </div>
</div>

<script>
/* ================= STATE ================= */
let currentMode = "price";
let scanLocked = false;
let cart = [];

const resultDiv = document.getElementById("result");
const cartDiv = document.getElementById("cart");

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" +
  Date.now();

let inventoryData = {};

/* ================= NAV ================= */
function goHome() {
  document.getElementById("landing").classList.remove("hidden");
  document.getElementById("scanner-ui").classList.add("hidden");
  document.getElementById("signout-ui").classList.add("hidden");
  resultDiv.innerText = "Waiting for scan...";
  cart = [];
  cartDiv.innerHTML = "";
  scanLocked = false;
}

function enterPriceMode() {
  currentMode = "price";
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("scanner-ui").classList.remove("hidden");
  document.getElementById("signout-ui").classList.add("hidden");
  resultDiv.innerText = "Waiting for scan...";
}

function enterSignOutMode() {
  currentMode = "signout";
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("scanner-ui").classList.remove("hidden");
  document.getElementById("signout-ui").classList.remove("hidden");
  resultDiv.innerText = "Scan samples to add to cart";
}

/* ================= LOAD INVENTORY ================= */
async function loadInventory() {
  const res = await fetch(SHEET_URL);
  const text = await res.text();

  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );

  const headers = rows[0];

  rows.slice(1).forEach(row => {
    const barcode = row[0];
    if (!barcode) return;

    const entry = {};
    headers.forEach((h, i) => {
      entry[h.trim()] = row[i]?.replace(/"/g, "").trim() || "";
    });

    if (!inventoryData[barcode]) inventoryData[barcode] = [];
    inventoryData[barcode].push(entry);
  });
}

/* ================= DISPLAY ================= */
function showVariants(barcode, items) {
  scanLocked = true;
  let html = `<div>Select item:</div>`;
  items.forEach(item => {
    html += `
      <div class="variant">
        <div>${item["Item Name"]}</div>
        <button onclick='selectItem(${JSON.stringify(item)})'>Select</button>
      </div>
    `;
  });
  resultDiv.innerHTML = html;
}

function selectItem(item) {
  if (currentMode === "price") {
    resultDiv.innerHTML = `<div>${item["Item Name"]}<br><b>${item["Price"]}</b></div>
      <button onclick="unlock()">Scan Next</button>`;
  } else {
    cart.push(item);
    renderCart();
    unlock();
  }
}

function renderCart() {
  cartDiv.innerHTML = "<h3>üõí Cart</h3>" +
    cart.map(i => `<div>${i["Item Name"]}</div>`).join("");
}

function unlock() {
  scanLocked = false;
  resultDiv.innerText =
    currentMode === "price" ? "Waiting for scan..." : "Scan next sample...";
}

/* ================= SCAN HANDLER ================= */
function handleBarcode(code) {
  const items = inventoryData[code];
  if (!items) {
    resultDiv.innerHTML = `<div>No match</div><button onclick="unlock()">Try Again</button>`;
    scanLocked = true;
    return;
  }
  showVariants(code, items);
}

/* ================= SCANNER ================= */
function startScanner() {
  loadInventory().then(() => {
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: { facingMode: "environment" }
      },
      decoder: { readers: ["code_128_reader"] }
    }, () => Quagga.start());

    Quagga.onDetected(data => {
      if (scanLocked) return;
      scanLocked = true;
      handleBarcode(data.codeResult.code);
    });
  });
}

/* ================= SUBMIT ================= */
function submitSignOut() {
  alert("Next step: Apps Script doPost()");
  console.log(cart);
}

document.addEventListener("DOMContentLoaded", startScanner);
</script>

</body>
</html>
