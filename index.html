<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner App</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 16px;
    font-size: 26px;
    max-width: 700px;
    margin: 0 auto;
  }

  h1 { font-size: 34px; margin-bottom: 16px; }

  button {
    padding: 18px 22px;
    font-size: 26px;
    width: 100%;
    max-width: 420px;
    cursor: pointer;
    border-radius: 14px;
    margin-top: 12px;
  }

  #video {
    width: 100%;
    max-width: 650px;
    height: 260px;
    border: 4px solid #222;
    border-radius: 16px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
  }

  #video video, #video canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
    display: block;
  }

  #result {
    margin-top: 28px;
    font-size: 30px;
    padding: 22px;
    border: 3px solid #333;
    border-radius: 16px;
    background: #f4f4f4;
    line-height: 1.4;
    font-weight: bold;
  }

  .hidden { display: none; }

  .variant {
    border: 2px solid #333;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
    background: #fff;
  }

  #landing-buttons { margin-top: 50px; }
</style>
</head>

<body>

<h1>üì¶ Inventory Scanner App</h1>

<!-- Landing Page -->
<div id="landing-page">
  <div id="landing-buttons">
    <button onclick="openPriceCheck()">üí≤ Price Check</button>
    <button onclick="openSignOut()">üìã Sample Sign Out</button>
  </div>
</div>

<!-- Price Check Page -->
<div id="price-check-page" class="hidden">
  <button onclick="goHome()">üè† Back</button>

  <div id="video"></div>

  <input
    type="text"
    id="barcodeInput"
    placeholder="Enter barcode or item name"
    onkeydown="if(event.key==='Enter') lookupManual()"
  />
  <button onclick="lookupManual()">Search</button>

  <div id="result">Waiting for scan...</div>
</div>

<!-- Sample Sign Out Page -->
<div id="signout-page" class="hidden">
  <button onclick="goHome()">üè† Back</button>
  <h2>üìã Sample Sign Out</h2>
  <p style="margin-top:20px;">
    This section will be built later.<br>
    Camera intentionally disabled here.
  </p>
</div>

<script>
/* ------------------ Navigation ------------------ */
function showPage(pageId) {
  stopScanner();
  document.getElementById('landing-page').classList.add('hidden');
  document.getElementById('price-check-page').classList.add('hidden');
  document.getElementById('signout-page').classList.add('hidden');
  document.getElementById(pageId).classList.remove('hidden');
}

function goHome() {
  showPage('landing-page');
}

function openPriceCheck() {
  showPage('price-check-page');
  startScanner();
}

function openSignOut() {
  showPage('signout-page');
}

/* ------------------ Price Check Logic ------------------ */
const resultDiv = document.getElementById("result");
const barcodeInput = document.getElementById("barcodeInput");
let scanLocked = false;
let scannerRunning = false;

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" + Date.now();

let inventoryData = {};

function formatSizeQuotes(text) {
  if (!text) return "";
  text = text.replace(/\b(\d+(?:-\d+)?\/\d+)\b/g, '$1"');
  text = text.replace(/x\s*(\d+)/g, 'x $1"');
  return text;
}

async function loadInventory() {
  const response = await fetch(SHEET_URL);
  const text = await response.text();
  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );
  const headers = rows[0];
  rows.slice(1).forEach(row => {
    if (!row[0]) return;
    const entry = {};
    headers.forEach((h, i) => {
      entry[h.trim()] = row[i]?.replace(/"/g, "").trim() || "";
    });
    const barcode = row[0].trim();
    if (!inventoryData[barcode]) inventoryData[barcode] = [];
    inventoryData[barcode].push(entry);
  });
}

function showVariant(barcode, item) {
  scanLocked = true;
  resultDiv.innerHTML = `
    <div>${formatSizeQuotes(item["Item Name"])}</div>
    <div style="font-size:38px;margin:12px 0;">${item["Price"]}</div>
    <button onclick="unlockScanner()">üì∑ Scan Next</button>
  `;
}

function showVariants(barcode, items) {
  scanLocked = true;
  let html = `<div style="margin-bottom:16px;">Select option:</div>`;
  items.forEach(item => {
    html += `
      <div class="variant">
        <div>${formatSizeQuotes(item["Item Name"])}</div>
        <div style="font-size:28px;margin:6px 0;">${item["Price"]}</div>
        <button onclick='showVariant("${barcode}", ${JSON.stringify(item)})'>Select</button>
      </div>
    `;
  });
  html += `<button onclick="unlockScanner()">Cancel</button>`;
  resultDiv.innerHTML = html;
}

function handleBarcode(barcode) {
  const items = inventoryData[barcode];
  if (!items) {
    resultDiv.innerHTML = `No match found<br><button onclick="unlockScanner()">Try Again</button>`;
    return;
  }
  items.length === 1 ? showVariant(barcode, items[0]) : showVariants(barcode, items);
}

function lookupManual() {
  const input = barcodeInput.value.trim().toLowerCase();
  if (!input) return;

  if (inventoryData[input]) return handleBarcode(input);

  const matches = [];
  for (const barcode in inventoryData) {
    inventoryData[barcode].forEach(item => {
      if (item["Item Name"].toLowerCase().includes(input)) {
        matches.push({ barcode, item });
      }
    });
  }

  if (!matches.length) {
    resultDiv.innerHTML = `No matches found<br><button onclick="unlockScanner()">Try Again</button>`;
    return;
  }

  if (matches.length === 1) return showVariant(matches[0].barcode, matches[0].item);

  let html = `<div style="margin-bottom:16px;">Multiple matches:</div>`;
  matches.forEach(m => {
    html += `
      <div class="variant">
        <div>${formatSizeQuotes(m.item["Item Name"])}</div>
        <div style="font-size:28px;margin:6px 0;">${m.item["Price"]}</div>
        <button onclick='showVariant("${m.barcode}", ${JSON.stringify(m.item)})'>Select</button>
      </div>
    `;
  });
  html += `<button onclick="unlockScanner()">Cancel</button>`;
  resultDiv.innerHTML = html;
}

function unlockScanner() {
  scanLocked = false;
  resultDiv.innerText = "Waiting for scan...";
  barcodeInput.value = "";
}

function startScanner() {
  if (scannerRunning) return;
  scannerRunning = true;

  loadInventory().then(() => {
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: { facingMode: "environment" }
      },
      decoder: { readers: ["code_128_reader"] },
      locate: true
    }, err => {
      if (err) {
        resultDiv.innerText = "Camera error.";
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(data => {
      if (!scanLocked) handleBarcode(data.codeResult.code);
    });
  });
}

function stopScanner() {
  if (scannerRunning) {
    Quagga.stop();
    scannerRunning = false;
  }
}
</script>

</body>
</html>
