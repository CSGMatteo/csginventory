<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Price Checker</title>

<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 24px;
  max-width: 700px;
  margin: 0 auto;
}

h1 { font-size: 32px; margin-bottom: 12px; }

#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 16px auto;
  overflow: hidden;
}

video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

input, button {
  font-size: 22px;
  padding: 14px;
  width: 100%;
  max-width: 420px;
  margin-top: 10px;
}

#result {
  margin-top: 20px;
  padding: 20px;
  border: 3px solid #333;
  border-radius: 16px;
  background: #f4f4f4;
}

.variant {
  border: 2px solid #333;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
  background: #fff;
}

.hidden { display: none; }
</style>
</head>

<body>

<h1>ðŸ’² Price Checker</h1>

<div id="video">
  <video id="videoElement"></video>
</div>

<input
  id="searchInput"
  placeholder="Enter barcode or product name"
  onkeydown="if(event.key==='Enter') manualSearch()"
/>

<button onclick="manualSearch()">Search</button>

<div id="result">Waiting for scanâ€¦</div>

<script>
/* ================= CONFIG ================= */

// ðŸ”´ REPLACE WITH YOUR PUBLISHED SHEET CSV
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/export?format=csv";

/* ================= STATE ================= */

let inventory = {};
let scanLocked = false;
let codeReader;

/* ================= LOAD SHEET ================= */

async function loadInventory() {
  const res = await fetch(SHEET_URL + "&t=" + Date.now());
  const text = await res.text();

  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );

  const headers = rows[0].map(h => h.replace(/"/g, "").trim());

  rows.slice(1).forEach(row => {
    const item = {};
    headers.forEach((h, i) => {
      item[h] = row[i]?.replace(/"/g, "").trim() || "";
    });

    if (!item[headers[0]]) return;

    const barcode = item[headers[0]];
    if (!inventory[barcode]) inventory[barcode] = [];
    inventory[barcode].push(item);
  });
}

/* ================= DISPLAY ================= */

function showSingle(item) {
  scanLocked = true;
  result.innerHTML = `
    <div>${item["Item Name"]}</div>
    <div style="font-size:36px;margin:10px 0;">
      ${item["Price"]}
    </div>
    <button onclick="unlock()">Scan Next</button>
  `;
}

function showMultiple(barcode, items) {
  scanLocked = true;
  let html = `<div>Select item:</div>`;
  items.forEach(item => {
    html += `
      <div class="variant">
        <div>${item["Item Name"]}</div>
        <div style="font-size:28px;">${item["Price"]}</div>
        <button onclick='showSingle(${JSON.stringify(item)})'>Select</button>
      </div>
    `;
  });
  html += `<button onclick="unlock()">Cancel</button>`;
  result.innerHTML = html;
}

/* ================= LOOKUP ================= */

function lookupBarcode(code) {
  const items = inventory[code];
  if (!items) {
    result.innerHTML = `
      <div>No match found</div>
      <button onclick="unlock()">Try Again</button>
    `;
    scanLocked = true;
    return;
  }

  items.length === 1
    ? showSingle(items[0])
    : showMultiple(code, items);
}

function manualSearch() {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) return;

  if (inventory[q]) {
    lookupBarcode(q);
    return;
  }

  const matches = [];
  for (const code in inventory) {
    inventory[code].forEach(item => {
      if (item["Item Name"].toLowerCase().includes(q)) {
        matches.push(item);
      }
    });
  }

  if (matches.length === 0) {
    result.innerHTML = `<div>No matches</div>`;
    return;
  }

  scanLocked = true;
  let html = `<div>Select item:</div>`;
  matches.forEach(item => {
    html += `
      <div class="variant">
        <div>${item["Item Name"]}</div>
        <div>${item["Price"]}</div>
        <button onclick='showSingle(${JSON.stringify(item)})'>Select</button>
      </div>
    `;
  });
  html += `<button onclick="unlock()">Cancel</button>`;
  result.innerHTML = html;
}

/* ================= SCANNER ================= */

function startScanner() {
  codeReader = new ZXing.BrowserMultiFormatReader();

  codeReader.decodeFromVideoDevice(
    null,
    "videoElement",
    (resultZX, err) => {
      if (resultZX && !scanLocked) {
        lookupBarcode(resultZX.text);
      }
    }
  );
}

function unlock() {
  scanLocked = false;
  searchInput.value = "";
  result.innerText = "Waiting for scanâ€¦";
}

/* ================= INIT ================= */

loadInventory().then(startScanner);
</script>

</body>
</html>
