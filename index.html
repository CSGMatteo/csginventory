<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner App</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 26px;
  max-width: 700px;
  margin: 0 auto;
}

h1 { font-size: 34px; margin-bottom: 16px; }

button {
  padding: 18px 22px;
  font-size: 26px;
  width: 100%;
  max-width: 420px;
  cursor: pointer;
  border-radius: 14px;
  margin-top: 12px;
}

#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 20px auto;
  overflow: hidden;
}

#video video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#result {
  margin-top: 28px;
  font-size: 30px;
  padding: 22px;
  border: 3px solid #333;
  border-radius: 16px;
  background: #f4f4f4;
  font-weight: bold;
}

.variant {
  border: 2px solid #333;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 12px;
  background: #fff;
}

.hidden { display: none; }
</style>
</head>

<body>

<h1>üì¶ Inventory Scanner App</h1>

<!-- Landing -->
<div id="landing">
  <button onclick="enterPriceMode()">üí≤ Price Check</button>
  <button onclick="enterSignOutMode()">üìã Sample Sign Out</button>
</div>

<!-- Scanner UI -->
<div id="scanner-ui" class="hidden">
  <button onclick="goHome()">üè† Home</button>

  <div id="video">
    <video id="camera" autoplay muted playsinline></video>
  </div>

  <input
    type="text"
    id="barcodeInput"
    placeholder="Enter barcode or item name"
    onkeydown="if(event.key==='Enter') lookupManual()"
  />
  <button onclick="lookupManual()">Search</button>

  <div id="result">Waiting for scan...</div>
</div>

<script>
/* ================= STATE ================= */
let currentMode = "price";
let scanLocked = false;
let inventoryData = {};

const resultDiv = document.getElementById("result");
const barcodeInput = document.getElementById("barcodeInput");

/* ================= INVENTORY ================= */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" +
  Date.now();

/* ================= NAV ================= */
function goHome() {
  stopScanner();
  document.getElementById("scanner-ui").classList.add("hidden");
  document.getElementById("landing").classList.remove("hidden");
  scanLocked = false;
}

function enterPriceMode() {
  currentMode = "price";
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("scanner-ui").classList.remove("hidden");
  resultDiv.innerText = "Waiting for scan...";
  startScanner();
}

function enterSignOutMode() {
  currentMode = "signout";
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("scanner-ui").classList.remove("hidden");
  resultDiv.innerHTML =
    "üìã Sample Sign Out is Under Maintenance<br>(Coming Soon)";
  stopScanner();
}

/* ================= LOAD INVENTORY ================= */
async function loadInventory() {
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = text.split("\n").map(r => r.split(","));
  const headers = rows.shift();

  rows.forEach(r => {
    if (!r[0]) return;
    const item = {};
    headers.forEach((h, i) => item[h.trim()] = (r[i] || "").replace(/"/g,""));
    if (!inventoryData[r[0]]) inventoryData[r[0]] = [];
    inventoryData[r[0]].push(item);
  });
}

/* ================= DISPLAY ================= */
function showVariant(item) {
  scanLocked = true;
  resultDiv.innerHTML = `
    <div>${item["Item Name"]}</div>
    <div style="font-size:36px">${item["Price"]}</div>
    <button onclick="unlockScanner()">üì∑ Scan Next</button>
  `;
}

function handleBarcode(code) {
  if (scanLocked) return;
  const items = inventoryData[code];
  if (!items) {
    resultDiv.innerHTML = "No match found";
    return;
  }
  showVariant(items[0]);
}

function lookupManual() {
  handleBarcode(barcodeInput.value.trim());
}

function unlockScanner() {
  scanLocked = false;
  resultDiv.innerText = "Waiting for scan...";
}

/* ================= ZXING SCANNER ================= */
const codeReader = new ZXing.BrowserMultiFormatReader();
let activeStream = null;

async function startScanner() {
  if (!Object.keys(inventoryData).length) await loadInventory();

  const video = document.getElementById("camera");
  const devices = await codeReader.listVideoInputDevices();
  const deviceId = devices[devices.length - 1].deviceId;

  codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
    if (result && currentMode === "price" && !scanLocked) {
      handleBarcode(result.text);
    }
  });
}

function stopScanner() {
  codeReader.reset();
}

</script>
</body>
</html>
