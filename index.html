<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Scanner App</title>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 16px;
  font-size: 26px;
  max-width: 700px;
  margin: 0 auto;
}

h1 { font-size: 34px; margin-bottom: 16px; }

button {
  padding: 18px 22px;
  font-size: 26px;
  width: 100%;
  max-width: 420px;
  cursor: pointer;
  border-radius: 14px;
  margin-top: 12px;
}

#video {
  width: 100%;
  max-width: 650px;
  height: 260px;
  border: 4px solid #222;
  border-radius: 16px;
  margin: 20px auto;
  position: relative;
  overflow: hidden;
}

#video video, #video canvas {
  width: 100% !important;
  height: 100% !important;
  object-fit: cover;
  display: block;
}

#result {
  margin-top: 28px;
  font-size: 30px;
  padding: 22px;
  border: 3px solid #333;
  border-radius: 16px;
  background: #f4f4f4;
  line-height: 1.4;
  font-weight: bold;
}

.variant {
  border: 2px solid #333;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 12px;
  background: #fff;
}

.hidden { display: none; }
</style>
</head>

<body>

<h1>üì¶ Inventory Scanner App</h1>

<!-- Landing -->
<div id="landing">
  <button onclick="enterPriceMode()">üí≤ Price Check</button>
  <button onclick="enterSignOutMode()">üìã Sample Sign Out</button>
</div>

<!-- Scanner UI -->
<div id="scanner-ui" class="hidden">
  <button onclick="goHome()">üè† Home</button>

  <div id="video"></div>

  <input
    type="text"
    id="barcodeInput"
    placeholder="Enter barcode or item name"
    onkeydown="if(event.key==='Enter') lookupManual()"
  />
  <button onclick="lookupManual()">Search</button>

  <div id="result">Waiting for scan...</div>
</div>

<script>
/* ================== GLOBAL STATE ================== */
let currentMode = "price";
let scanLocked = false;

const resultDiv = document.getElementById("result");
const barcodeInput = document.getElementById("barcodeInput");

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1VMPWmQUbbHK0JE_8ldfsc2G454vVPkFnLhjATuVKil8/export?format=csv&t=" +
  new Date().getTime();

let inventoryData = {};

/* ================== NAVIGATION ================== */
function goHome() {
  document.getElementById("landing").classList.remove("hidden");
  document.getElementById("scanner-ui").classList.add("hidden");
  resultDiv.innerText = "Waiting for scan...";
  scanLocked = false;
}

function enterPriceMode() {
  currentMode = "price";
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("scanner-ui").classList.remove("hidden");
  resultDiv.innerText = "Waiting for scan...";
}

function enterSignOutMode() {
  // Instead of opening scanner, show Coming Soon message
  currentMode = "signout";
  document.getElementById("landing").classList.add("hidden");
  document.getElementById("scanner-ui").classList.remove("hidden");
  resultDiv.innerHTML = "<div style='font-size:32px;margin-top:40px;'>üìã Sample Sign Out is Under Maintenance (Coming Soon)</div>";
}

/* ================== UTIL ================== */
function formatSizeQuotes(text) {
  if (!text) return "";
  text = text.replace(/\b(\d+(?:-\d+)?\/\d+)\b/g, '$1"');
  text = text.replace(/x\s*(\d+)(?!-\d+\/\d+)/g, 'x $1"');
  return text;
}

/* ================== LOAD INVENTORY ================== */
async function loadInventory() {
  const res = await fetch(SHEET_URL);
  const text = await res.text();

  const rows = text.split("\n").map(r =>
    r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []
  );

  const headers = rows[0];

  rows.slice(1).forEach(row => {
    if (!row[0]) return;
    const entry = {};
    headers.forEach((h, i) => {
      entry[h.trim()] = row[i]?.replace(/"/g, "").trim() || "";
    });
    const barcode = row[0].trim();
    if (!inventoryData[barcode]) inventoryData[barcode] = [];
    inventoryData[barcode].push(entry);
  });
}

/* ================== DISPLAY ================== */
function showVariant(barcode, item) {
  scanLocked = true;
  resultDiv.innerHTML = `
    <div>${formatSizeQuotes(item["Item Name"])}</div>
    <div style="font-size:38px;margin:12px 0;">
      ${item["Price"]}
    </div>
    <button onclick="unlockScanner()">üì∑ Scan Next</button>
  `;
}

function showVariants(barcode, items) {
  scanLocked = true;
  let html = `<div style="margin-bottom:16px;">Select option:</div>`;
  items.forEach(item => {
    html += `
      <div class="variant">
        <div>${formatSizeQuotes(item["Item Name"])}</div>
        <div style="font-size:28px;margin:6px 0;">
          ${item["Price"]}
        </div>
        <button onclick='showVariant("${barcode}", ${JSON.stringify(item)})'>
          Select
        </button>
      </div>
    `;
  });
  html += `<button onclick="unlockScanner()">Cancel</button>`;
  resultDiv.innerHTML = html;
}

/* ================== HANDLERS ================== */
function handleBarcode(barcode) {
  const items = inventoryData[barcode];
  if (!items) {
    resultDiv.innerHTML = `
      <div>No match found</div><br>
      <button onclick="unlockScanner()">Try Again</button>
    `;
    return;
  }
  if (items.length === 1) showVariant(barcode, items[0]);
  else showVariants(barcode, items);
}

function lookupManual() {
  const input = barcodeInput.value.trim().toLowerCase();
  if (!input) return;

  if (inventoryData[input]) {
    handleBarcode(input);
    return;
  }

  const matches = [];
  for (const barcode in inventoryData) {
    inventoryData[barcode].forEach(item => {
      if (item["Item Name"].toLowerCase().includes(input)) {
        matches.push({ barcode, item });
      }
    });
  }

  if (matches.length === 0) {
    resultDiv.innerHTML = `<div>No matches</div>`;
    return;
  }

  if (matches.length === 1) {
    showVariant(matches[0].barcode, matches[0].item);
    return;
  }

  let html = `<div>Multiple matches:</div>`;
  matches.forEach(m => {
    html += `
      <div class="variant">
        <div>${formatSizeQuotes(m.item["Item Name"])}</div>
        <div>${m.item["Price"]}</div>
        <button onclick='showVariant("${m.barcode}", ${JSON.stringify(m.item)})'>
          Select
        </button>
      </div>
    `;
  });
  resultDiv.innerHTML = html;
}

function unlockScanner() {
  scanLocked = false;
  barcodeInput.value = "";
  resultDiv.innerText = currentMode === "price"
    ? "Waiting for scan..."
    : "Scan next sample...";
}

/* ================== SCANNER ================== */
function startScanner() {
  loadInventory().then(() => {
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector("#video"),
        constraints: {
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        area: { top: "40%", bottom: "40%", left: "10%", right: "10%" }
      },
      decoder: { readers: ["code_128_reader"] },
      locate: true
    }, err => {
      if (err) {
        resultDiv.innerText = "Camera error.";
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(data => {
      if (scanLocked || currentMode !== "price") return; // Scanner only active in Price mode
      handleBarcode(data.codeResult.code);
    });
  });
}

document.addEventListener("DOMContentLoaded", startScanner);
</script>

</body>
</html>
